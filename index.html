<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="coi-serviceworker.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EngDraft Ultra-Speed v5</title>
  <style>
    :root { --primary: #00e676; --bg: #050505; --card: #121212; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; }
    .action-bar { background: var(--primary); padding: 15px; color: black; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
    .container { padding: 20px; max-width: 500px; margin: auto; }
    .status-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center; border: 1px solid #222; }
    .speed-control { font-size: 12px; display: flex; align-items: center; gap: 5px; }
    select { background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 2px; }
    textarea { width: 100%; background: #1a1a1a; color: white; border: 1px solid #333; border-radius: 12px; padding: 15px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; height: 150px; }
    button { width: 100%; background: var(--primary); color: black; border: none; padding: 18px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
    button:disabled { opacity: 0.3; }
    audio { width: 100%; margin-top: 20px; }
    #buffer-info { font-size: 11px; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="action-bar">
    <span>ENGDRAFT V5</span>
    <div class="speed-control">
      Playback:
      <select id="speedRate">
        <option value="0.8" selected>0.8x (Safe)</option>
        <option value="1.0">1.0x (Normal)</option>
      </select>
    </div>
  </div>

  <div class="container">
    <div class="status-card">
      <span id="status">Waking AI...</span>
      <div id="buffer-info">Waiting for input</div>
    </div>
    <textarea id="text">The smart grid is a digital power network. It uses sensors to monitor electricity flow. This system helps reduce energy waste daily. Engineers use AI to balance the load effectively.</textarea>
    <button id="speak" disabled>PLAY WITH AUTO-SYNC</button>
    <audio id="audio" controls></audio>
  </div>

  <script type="module">
    const worker = new Worker('worker.js', { type: 'module' });
    const statusEl = document.getElementById("status");
    const bufferInfo = document.getElementById("buffer-info");
    const button = document.getElementById("speak");
    const audioEl = document.getElementById("audio");
    const speedRate = document.getElementById("speedRate");

    let audioQueue = [];
    let isPlaying = false;
    let isBufferingFirstTime = true;

    worker.postMessage({ type: 'init' });

    worker.onmessage = (e) => {
      if (e.data.type === 'ready') {
        statusEl.textContent = "Turbo Ready";
        button.disabled = false;
      }
      if (e.data.type === 'audio') {
        const url = URL.createObjectURL(e.data.blob);
        audioQueue.push(url);
        bufferInfo.textContent = `Buffered segments: ${audioQueue.length}`;
        
        // CTO LOGIC: Wait for at least 2 chunks before starting the very first time
        // This ensures the worker stays ahead of the speaker
        if (!isPlaying && (audioQueue.length >= 2 || !isBufferingFirstTime)) {
          isBufferingFirstTime = false;
          playNext();
        }
      }
      if (e.data.type === 'status') statusEl.textContent = e.data.message;
    };

    async function playNext() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        statusEl.textContent = "Syncing...";
        return;
      }
      isPlaying = true;
      statusEl.textContent = "Playing...";
      
      const currentUrl = audioQueue.shift();
      audioEl.src = currentUrl;
      audioEl.playbackRate = parseFloat(speedRate.value);
      
      try {
        await audioEl.play();
      } catch(err) { console.warn("Interacted needed"); }

      audioEl.onended = () => {
        URL.revokeObjectURL(currentUrl);
        bufferInfo.textContent = `Buffered segments: ${audioQueue.length}`;
        playNext();
      };
    }

    button.onclick = () => {
      audioQueue = [];
      isPlaying = false;
      isBufferingFirstTime = true; // Reset buffer logic
      audioEl.pause();
      statusEl.textContent = "Pre-loading buffer...";
      worker.postMessage({ 
        type: 'generate', 
        text: document.getElementById("text").value, 
        voice: 'af_bella' 
      });
    };
  </script>
</body>
</html>